{% extends "base.html" %}

<a href="{{ url_for('mood_pdf', entry_id=entry[0]) }}" 
   style="display:inline-block; background:#3f51b5; color:white; padding:8px 14px; border-radius:6px; text-decoration:none; margin-bottom:20px;">
  ğŸ“„ PDFë¡œ ì €ì¥
</a>

{% block content %}
<h2>ë¬´ë“œ í˜ì´ì§€ ìƒì„¸</h2>

{% if entry %}
  <!-- ê¸°ë³¸ ì •ë³´ -->
  <p><strong>ë‚ ì§œ:</strong> {{ entry[1] }}</p>
  <p><strong>ì¼ê¸° ë‚´ìš©:</strong></p>
  <div style="white-space: pre-line; background:#fafafa; padding:10px; border-radius:8px; margin-bottom:20px;">
    {{ entry[2] }}
  </div>

  <hr>

  <!-- ê°ì • ë¶„ì„ ê²°ê³¼ -->
  <h3>ê°ì • ë¶„ì„ ê²°ê³¼</h3>

  {% if sentiment %}
    {% if sentiment.summary %}
      <p><strong>ìš”ì•½:</strong> {{ sentiment.summary }}</p>
    {% endif %}

    {% if sentiment.keywords %}
      <p><strong>ê°ì • í‚¤ì›Œë“œ:</strong>
        {% for kw in sentiment.keywords %}
          <span style="background:#e0f7fa; padding:4px 8px; border-radius:6px; margin-right:5px;">{{ kw }}</span>
        {% endfor %}
      </p>
    {% endif %}

    <!-- ê°ì • ì§€ìˆ˜ ê·¸ë˜í”„ -->
    <h4>ê°ì • ì§€ìˆ˜</h4>
    <canvas id="emotionChart" style="max-width:400px;"></canvas>

    <!-- ê¸/ë¶€ì • ë¹„ìœ¨ ê·¸ë˜í”„ -->
    <h4 style="margin-top:30px;">ê¸ì • / ë¶€ì • ë¹„ìœ¨</h4>
    <canvas id="ratioChart" style="max-width:400px;"></canvas>

    <script>
      // Flaskì—ì„œ ì „ë‹¬ëœ JSON ë°ì´í„° (íŒŒì‹± ë¶ˆí•„ìš”)
      const emotionData = {{ sentiment.emotion_scores | tojson }};
      const ratioData = {{ sentiment.pos_neg_ratio | tojson }};

      // ê°ì • ì§€ìˆ˜ ë„ë„› ê·¸ë˜í”„
      (() => {
        const el = document.getElementById("emotionChart");
        if (!el) return;

        const labels = Object.keys(emotionData || {});
        const values = Object.values(emotionData || {});
        if (labels.length === 0) {
          el.insertAdjacentHTML('beforebegin', '<p>âš ï¸ ê°ì • ì§€ìˆ˜ë¥¼ í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
          el.remove();
          return;
        }

        const ctx = el.getContext("2d");
        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: values,
              backgroundColor: [
                '#4fc3f7', '#81c784', '#ffb74d', '#e57373', '#ba68c8', '#90a4ae'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
          }
        });
      })();

      // ê¸ì •/ë¶€ì • ë¹„ìœ¨ ìŠ¤íƒ ë°”
      (() => {
        const el = document.getElementById("ratioChart");
        if (!el) return;

        const pos = Number((ratioData.positive ?? 0) * 100);
        const neg = Number((ratioData.negative ?? 0) * 100);
        if ((pos + neg) <= 0) {
          el.insertAdjacentHTML('beforebegin', '<p>âš ï¸ ê¸/ë¶€ì • ë¹„ìœ¨ ë°ì´í„°ë¥¼ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>');
          el.remove();
          return;
        }

        const ctx = el.getContext("2d");
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['ê°ì • ë¹„ìœ¨'],
            datasets: [
              {
                label: 'ê¸ì •',
                data: [pos],
                backgroundColor: '#4caf50',
                borderRadius: 8
              },
              {
                label: 'ë¶€ì •',
                data: [neg],
                backgroundColor: '#f44336',
                borderRadius: 8
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            scales: {
              x: {
                stacked: true,
                max: 100,
                ticks: { callback: v => v + '%' }
              },
              y: { stacked: true }
            },
            plugins: { legend: { position: 'bottom' } }
          }
        });
      })();
    </script>
  {% else %}
    <p>ê°ì • ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}

  <hr>

  <!-- ì—…ë¡œë“œí•œ ì‚¬ì§„ -->
  {% if entry[4] %}
    <h3>ì—…ë¡œë“œí•œ ì‚¬ì§„</h3>
    <img src="{{ url_for('static', filename=entry[4].replace('static/', '')) }}"
         alt="Uploaded photo"
         style="width:320px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.15); margin-bottom:20px;">
  {% endif %}

  <!-- ì‚¬ì§„ ë¶„ì„ ê²°ê³¼ -->
  {% if sentiment.photo_mood %}
    <div style="margin-top:20px; padding:15px; border-radius:12px; background:#fafafa; box-shadow:inset 0 0 5px rgba(0,0,0,0.05);">
      <h3>ğŸ“¸ ì‚¬ì§„ ë¶„ì„ ê²°ê³¼</h3>
          <p><strong>ì‚¬ì§„ì—ì„œ ëŠê»´ì§€ëŠ” ë¶„ìœ„ê¸°:</strong> {{ sentiment.photo_mood }}</p>
    </div>
  {% endif %}

  <!-- ìƒ‰ìƒ íŒ”ë ˆíŠ¸ -->
  {% if palette %}
    <h3 style="margin-top:30px;">ë¬´ë“œ íŒ”ë ˆíŠ¸</h3>
    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      {% for color in palette %}
        <div style="width:40px; height:40px; border-radius:6px; border:1px solid #ccc; background:{{ color }}"></div>
      {% endfor %}
    </div>
  {% endif %}
{% else %}
  <p>í•´ë‹¹ ì¼ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}
{% endblock %}
